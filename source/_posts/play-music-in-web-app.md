title: 在移动设备上使用HTML5特性播放音频文件遇到的问题
date: 2016-01-04 15:11:53
tags: [HTML5,Javascript]
categories: 前端
---

最近做了一个用在移动客户端上的老虎机单页，有一个老虎机转动时播放音效的需求，在实现的时候碰到了问题。

<!-- more -->

需求很简单，在下图所示的老虎机页面上，点击GO按钮开始转动老虎机，同时播放一个转动的音效，点击3个相应积分的下注按钮的时候，播放下注音效。

![](http://ww1.sinaimg.cn/large/7d25d640jw1eznhwrzzymj20bh0kago5.jpg)

但是在PC端测试播放没有任何问题的老虎机转动音效，在移动设备上总是不能顺利的播放出来；奇怪的是，下注按钮的音效却完全没有这个问题，而且一旦我点击下注按钮触发过下注音效后，老虎机转动音效就能够正常播放了，这个问题困扰了我一整天的时间还是没找到解决办法。

第二天我仔细分析了一下我遇到的问题，转动音效和下注音效引用的是同一个音频文件
```html
<audio src="http://yuedust.yuedu.126.net/assets/mobile/activity/slot2015/res/roll.mp3" controls="controls" preload="auto" id="rollSound" hidden=""></audio>
```
但是为什么一个能正常播放，一个却不能呢，而且这个问题在PC端的浏览器上没有出现？要说两者的区别，只有一个：那就是下注音效是直接由**用户的操作**来调用的，而老虎机的转动音效，由于需要向服务端查询本次老虎机的转动结果，调用时机是在**ajax请求的回调函数**中。所以我猜想这跟移动设备的HTML5音频播放机制有关，通过这一切入点搜索，果然得到了我想要的结果。

这是[Stack Overflow](http://stackoverflow.com/questions/15088638/playing-html5-audio-from-mobile-devices-from-callback)搜索到的相关问题和解答。

**总结来说**：
为了防止在移动设备上自动载入一些占用空间较大的文件（比如音频文件）消耗无谓的内存，移动设备的浏览器上都限制了这类文件的载入机制，那就是必须由用户的直接操作来触发，而Javascript回调函数是不行的，并且，一旦由用户直接操作触发过一次以后，只要这个文件在Javascript中的引用没有被改变，之后的触发就没有限制了。
这就解释了为什么在移动设备上，直接去点击GO按钮无法触发转动音效，却可以通过下注按钮触发下注音效，并且使转动音效也恢复正常，这正是因为我的页面中这两个音效是储存在同一个文件中的。

**解决办法**:
解决办法也很简单，就是在用户点击GO按钮这个直接操作之后，立即播放这个音频，又立即暂停播放，这样用户其实是听不到音频的，但是我们却通过这个方式成功载入了音频文件，并拿到了它的引用，之后就可以成功的在ajax请求的回调中随心所欲地使用它了。